const express = require('express');
const multer = require('multer');
const fs = require('fs');
const path = require('path');
const app = express();
const port = 3000;

// Konfigurasi Upload
const storage = multer.diskStorage({
    destination: 'public/uploads/',
    filename: (req, file, cb) => {
        cb(null, Date.now() + path.extname(file.originalname));
    }
});
const upload = multer({ storage: storage });

app.set('view engine', 'ejs');
app.use(express.static('public'));
app.use(express.urlencoded({ extended: true }));

// Database dummy
let books = [];
if (fs.existsSync('books.json')) {
    books = JSON.parse(fs.readFileSync('books.json'));
}

// HALAMAN UTAMA PEMBELI
app.get('/', (req, res) => {
    res.render('index', { books: books });
});

// HALAMAN ADMIN RAHASIA (Mode Kelola Kamu)
app.get('/kelola-jestri', (req, res) => {
    res.render('admin', { books: books });
});

// FITUR TAMBAH BUKU
app.post('/add-book', upload.single('img'), (req, res) => {
    const { title, price, genre } = req.body;
    const newBook = { title, price, genre, img: req.file.filename };
    books.push(newBook);
    fs.writeFileSync('books.json', JSON.stringify(books));
    res.redirect('/kelola-jestri');
});

// FITUR HAPUS BUKU
app.post('/delete-book/:id', (req, res) => {
    books.splice(req.params.id, 1);
    fs.writeFileSync('books.json', JSON.stringify(books));
    res.redirect('/kelola-jestri');
});

app.listen(port, () => {
    console.log(`E-BOOK JESTRI aktif di http://localhost:${port}`);
});

